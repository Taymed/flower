<!DOCTYPE html>
<html>
<head>
<title>Flower Clicker</title>
<style>
  /* CSS Improvements:  More organized, using variables, and some minor tweaks */
  :root {
    --petal-width: 30px;
    --petal-height: 60px;
    --stem-width: 6px;
    --stem-height: 80px;
    --flower-size: 200px; /* Consistent flower size */
  }

  body {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    margin: 0;
    transition: background-color 0.5s ease;
    font-family: sans-serif;
    background-color: #ADD8E6; /* Default background */
    overflow-x: hidden; /* Prevent horizontal scrollbar */
  }

  h1 {
    background: linear-gradient(to right, #FF69B4, #FFB6C1);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-size: 3em;
    margin-bottom: 20px;
    text-align: center; /* Center the heading */
  }

  #flowerContainer {
    position: relative;
    width: var(--flower-size);
    height: var(--flower-size);
    cursor: pointer;
    display: flex;
    flex-direction: column; /* Stack stem, petals, and message vertically */
    justify-content: center;
    align-items: center;
    overflow: visible;
    transition: transform 0.1s ease-in-out; /* Add subtle click animation */
  }

  #flowerContainer:active {
    transform: scale(0.95); /* Subtle shrink on click */
  }

  .petal {
    position: absolute;
    width: var(--petal-width);
    height: var(--petal-height);
    background: linear-gradient(to bottom, var(--petal-color-start), var(--petal-color-end));
    border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
    transform-origin: bottom center;
    top: calc(0px - var(--petal-height) / 2); /* Correct petal positioning */
    pointer-events: none; /* Petals shouldn't block clicks */
  }

  #stem {
    position: relative; /* Make stem relative for stacking context */
    bottom: 0;
    width: var(--stem-width);
    height: var(--stem-height);
    background-color: green;
  }


  /* Add a message when there are no petals left */
  #noPetalsMessage {
    font-size: 1.2em;
    color: #888;
    display: none; /* Initially hidden */
    margin-top: 10px; /* Add some space above the message */
    text-align: center;
  }

  #flowerContainer.no-petals #noPetalsMessage {
    display: block; /* Show message when no petals are left */
  }

  /* Style for the falling flower emojis */
  .falling-flower {
    position: absolute;
    font-size: 2em; /* Adjust size as needed */
    pointer-events: none; /*  Don't interfere with clicks */
    user-select: none;    /*  Prevent text selection */
    animation: fall 3s linear forwards; /* Use a CSS animation */
  }

  @keyframes fall {
    0% {
      opacity: 1;
      transform: translateY(0) rotate(0deg);
    }
    100% {
      opacity: 0;
      transform: translateY(100vh) rotate(720deg); /* Rotate as it falls */
    }
  }

</style>
</head>
<body>

<h1>Flower Clicker</h1>
<div id="flowerContainer">
  <div id="stem"></div>
  <div id="noPetalsMessage">Click to Grow New Flower!</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
<script>
  // JavaScript Improvements:  More efficient, readable, and robust

  const flowerContainer = document.getElementById('flowerContainer');
  const body = document.body;
  let petals = [];

  // Color palettes - consider storing these in a separate JSON file for easier management
  const petalColorOptions = [
    { start: '#FF69B4', end: '#FFB6C1' },
    { start: '#FFA07A', end: '#FFDAB9' },
    { start: '#9370DB', end: '#E6E6FA' },
    { start: '#87CEFA', end: '#B0E2FF' },
    { start: '#32CD32', end: '#90EE90' },
    { start: '#FF4500', end: '#FFA07A' },
    { start: '#4682B4', end: '#ADD8E6' },
    { start: '#7B68EE', end: '#DDA0DD' },
    { start: '#F0E68C', end: '#EEE8AA' }
  ];

  const rainbowColors = ['red', 'orange', 'yellow', 'green', 'blue', 'indigo', 'violet'];

  const backgroundColors = [
    '#ADD8E6',
    '#B0E2FF',
    '#98FB98'
  ];

  let currentColorIndex = 0;
  let petalCount = 0; // Initialize petalCount to 0
  let rainbowFlowerChance = 0.1;

  // Audio Context - Moved outside functions for better performance
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();

  // Frequencies for C Major Pentatonic Scale (C-D-E-G-A)
  const c4 = 261.63;
  const d4 = 293.66;
  const e4 = 329.63;
  const g4 = 392.00;
  const a4 = 440.00;
  const c5 = 523.25;
  const eb4 = 311.13; // Eb4 (from C minor pentatonic - for modal mixture)
  const bb4 = 466.16; // Bb4 (from C minor pentatonic - for modal mixture)

  // Melodic Phrases based on C Major Pentatonic with Rhythmic Variation
  const melodicPhrases = [
    [c4, d4, e4, g4],       // Phrase 1: C - D - E - G
    [e4, d4, c4, a4],       // Phrase 2: E - D - C - A
    [g4, a4, c5, e4],       // Phrase 3: G - A - C (octave) - E
    [a4, g4, e4, d4],       // Phrase 4: A - G - E - D
    [c4, e4, g4, c5],       // Phrase 5: C - E - G - C (octave)
    [d4, c4, a4, g4],       // Phrase 6: D - C - A - G
    [e4, g4, a4, e4],       // Phrase 7: E - G - A - E
    [g4, e4, d4, c4],       // Phrase 8: G - E - D - C
    [c4, eb4, g4, bb4],     // Phrase 9: C - Eb - G - Bb (Minor Pentatonic - Use Sparingly!)
    [e4, c4, g4],           // Phrase 10: E - C - G (Simple Triad)
    [a4, e4, c4],           // Phrase 11: A - E - C (Simple Triad)
    [g4, d4, c4],           // Phrase 12: G - D - C
    [c5, a4, g4, e4],       // Phrase 13: C5 - A - G - E
    [d4, g4, c5]            // Phrase 14: D - G - C5
  ];

  // Function to play a single note with more control over ADSR envelope
  function playNote(frequency, startTime, duration, gainValue, attack, decay, sustainLevel, release) {
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();

    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(frequency, startTime);

    gainNode.gain.setValueAtTime(0, startTime); // Start at zero volume

    // Attack
    gainNode.gain.linearRampToValueAtTime(gainValue, startTime + attack);

    // Decay & Sustain
    gainNode.gain.exponentialRampToValueAtTime(gainValue * sustainLevel, startTime + attack + decay);

    // Release
    gainNode.gain.exponentialRampToValueAtTime(0.0001, startTime + duration - release);

    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);

    oscillator.start(startTime);
    oscillator.stop(startTime + duration);
  }


  function playPhrase(phrase) {
    const now = audioContext.currentTime;
    const noteDuration = 0.4; // Slightly longer notes
    const gap = 0.1;
    let time = now;
    const gainValue = 0.06; // Reduced gain for softer sound

    // ADSR Envelope parameters (Attack, Decay, Sustain Level, Release)
    const attack = 0.05;
    const decay = 0.1;
    const sustainLevel = 0.6; //Sustain level as a fraction of the peak gain
    const release = 0.2;

    phrase.forEach(frequency => {
      playNote(frequency, time, noteDuration, gainValue, attack, decay, sustainLevel, release);
      time += noteDuration + gap;
    });
  }


  function createPetal(index, isRainbow = false) {
    const petal = document.createElement('div');
    petal.classList.add('petal');
    petal.style.transform = `rotate(${index * (360 / petalCount)}deg)`;
    petal.dataset.index = index;

    if (isRainbow) {
      petal.style.background = rainbowColors[index % rainbowColors.length];
    } else {
      petal.style.setProperty('--petal-color-start', petalColorOptions[currentColorIndex].start);
      petal.style.setProperty('--petal-color-end', petalColorOptions[currentColorIndex].end);
    }

    flowerContainer.appendChild(petal);
    return petal; // Return the petal
  }


  function animatePetalFall(petal) {
    const randomX = Math.random() * 200 - 100;
    const randomRotation = Math.random() * 360;
    const fallDuration = Math.random() * 1 + 1;

    // Play a random phrase from the melodicPhrases array
    const randomIndex = Math.floor(Math.random() * melodicPhrases.length);
    playPhrase(melodicPhrases[randomIndex]);

    gsap.to(petal, {
      y: 200,
      x: randomX,
      rotation: randomRotation,
      opacity: 0,
      duration: fallDuration,
      ease: "power2.inOut",
      onComplete: () => {
        petal.remove();
        createFallingFlowerEmoji(); // Create emoji after petal falls
      }
    });
  }

    function createFallingFlowerEmoji() {
        const emojis = ['ðŸŒ¸', 'ðŸŒ¼', 'ðŸŒº', 'ðŸŒ»', 'ðŸŒ·', 'ðŸŒ¹'];
        const emoji = document.createElement('div');
        emoji.classList.add('falling-flower');
        emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];

        // Position the emoji randomly at the top of the screen
        emoji.style.left = `${Math.random() * 100}vw`;
        emoji.style.top = '0'; // Start at the top
        document.body.appendChild(emoji);

        // Remove the emoji after the animation completes
        emoji.addEventListener('animationend', () => {
            emoji.remove();
        });
    }

  function setBackgroundColor() {
    body.style.backgroundColor = backgroundColors[currentColorIndex];
    currentColorIndex = (currentColorIndex + 1) % backgroundColors.length;
  }

  function resetFlower() {
    // Clear existing petals efficiently
    petals.forEach(petal => petal.remove());
    petals = [];

    petalCount = Math.floor(Math.random() * 10) + 5;
    currentColorIndex = Math.floor(Math.random() * petalColorOptions.length);
    setBackgroundColor();

    let isRainbowFlower = Math.random() < rainbowFlowerChance;

    // Create new petals and store them in the petals array
    for (let i = 0; i < petalCount; i++) {
      const petal = createPetal(i, isRainbowFlower);
      petals.push(petal);
    }

    // Remove the 'no-petals' class
    flowerContainer.classList.remove('no-petals');
  }


  function handleFlowerClick() {
    if (petals.length > 0) {
      const randomIndex = Math.floor(Math.random() * petals.length);
      const petalToFall = petals[randomIndex];
      animatePetalFall(petalToFall);
      petals.splice(randomIndex, 1); // Remove petal from array


      if (petals.length === 0) {
        flowerContainer.classList.add('no-petals'); // Add class when no petals
      }
    } else {
      resetFlower();
    }
  }


  flowerContainer.addEventListener('click', handleFlowerClick);

  // Initial flower creation
  resetFlower();
</script>

</body>
</html>
